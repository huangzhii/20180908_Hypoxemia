setwd("/home/zhihuan/Downloads/Hypoxemia - LSTM/PO2data/PO2数据/总人群")
library(anytime)
library(tictoc)
nonvent = read.csv("mimic_mimiciii_po2_nonvent_bmi.csv", header = F, stringsAsFactors = F)
vent = read.csv("mimic_mimiciii_po2_vent_bmi.csv", header = F, stringsAsFactors = F)
label = levels(unlist(read.table("label.tsv", sep = "\t")))
vent = vent[,-11]
colnames(nonvent) = label
colnames(vent) = label
nonvent$`is_vent` = 0
vent$`is_vent` = 1
alldata = rbind(vent, nonvent)
alldata$ADMI_TIME = anytime(alldata$ADMI_TIME)
alldata$OUT_TIME = anytime(alldata$OUT_TIME)
alldata$ADMI_TIME_numeric = as.numeric(alldata$ADMI_TIME)
alldata$OUT_TIME_numeric = as.numeric(alldata$OUT_TIME)
# start expanding data
expand.data = NULL
start_time <- proc.time()
allhours = 0
for (i in 1:dim(alldata)[1]){
if (i %% 100 == 0){
message(i, "  -  ", allhours, "    Elapsed: ", round((proc.time() - start_time)[3], 2), " secs")
}
row = alldata[i,]
time.in = row$ADMI_TIME_numeric
time.out = row$OUT_TIME_numeric
hours = (time.out - time.in)/3600
allhours = allhours + hours
for (j in 0:hours){
numerical.time = time.in + 3600*j
time = as.character(anytime(numerical.time))
if (nchar(time) < 12){
time = paste0(time, " 00:00:00")
}
newrow = c(row$ICUSTAY_ID, row$SUBJECT_ID, row$HADM_ID, time, row$AGE, row$LOS,
row$GENDER, row$HEIGHT, row$WEIGHT, row$BMI, row$is_vent)
expand.data = rbind(expand.data, newrow)
}
}
